---
import type { GetStaticPaths } from 'astro';
import { getCollection } from 'astro:content';
import PostCard from "~/components/PostCard.astro";
import Layout from "~/layouts/Layout.astro";

export const getStaticPaths = (async ({ paginate }) => {
  const posts = (await getCollection('blog')).sort(
    (a, b) => b.data.date.valueOf() - a.data.date.valueOf()
  );

  // Get all tags with frequency
  const tagFrequency: Record<string, number> = {};
  posts.forEach(post => {
    post.data.tags?.forEach(tag => {
      tagFrequency[tag] = (tagFrequency[tag] || 0) + 1;
    });
  });

  // Sort tags by frequency
  const sortedTags = Object.entries(tagFrequency)
    .sort((a, b) => b[1] - a[1])
    .map(([tag, count]) => ({ tag, count }));

  return paginate(posts, {
    pageSize: 10,
    props: { sortedTags }
  });
}) satisfies GetStaticPaths;

const { page, sortedTags } = Astro.props;

// Extract preview from markdown body (remove frontmatter, headings, code blocks, etc.)
function getPreview(body: string, maxLength: number = 150): string {
  return body
    .replace(/^---[\s\S]*?---/m, '') // remove frontmatter
    .replace(/#{1,6}\s+.*/g, '') // remove headings
    .replace(/```[\s\S]*?```/g, '') // remove code blocks
    .replace(/`[^`]+`/g, '') // remove inline code
    .replace(/\[([^\]]+)\]\([^)]+\)/g, '$1') // convert links to text
    .replace(/[*_~]+/g, '') // remove emphasis markers
    .replace(/\n+/g, ' ') // replace newlines with space
    .trim()
    .slice(0, maxLength);
}
---

<Layout title="Posts @TriFullKim" id="post">
  <main>
    <div class="post-space">
      {
        page.data.map(post => (
          <PostCard
            slug={post.slug}
            title={post.data.title}
            createdTime={post.data.date.toISOString()}
            tags={post.data.tags}
          >
            {post.data.description || post.data.summary || getPreview(post.body)}
          </PostCard>
        ))
      }
    </div>

    <!-- Pagination Navigation -->
    {page.lastPage > 1 && (
      <nav class="pagination">
        <a href={page.url.prev || '#'} class:list={['nav-btn', { disabled: !page.url.prev }]}>
          &lt;
        </a>

        {Array.from({ length: page.lastPage }, (_, i) => i + 1).map(num => (
          <a
            href={num === 1 ? '/post' : `/post/${num}`}
            class:list={['page-num', { active: num === page.currentPage }]}
          >
            {num}
          </a>
        ))}

        <a href={page.url.next || '#'} class:list={['nav-btn', { disabled: !page.url.next }]}>
          &gt;
        </a>
      </nav>
    )}

    <!-- Tag List sorted by frequency -->
    <section class="tag-section">
      <h3 class="tag-title">Tags</h3>
      <div class="tag-list">
        {sortedTags.map(({ tag, count }) => (
          <a href={`/tags/${tag}`} class="tag-item">
            #{tag} <span class="tag-count">({count})</span>
          </a>
        ))}
      </div>
    </section>
  </main>
</Layout>

<style>
  .post-space {
    display: grid;
    grid-template-columns: 1fr;
    gap: 0.75rem;
    padding: 10px;
  }

  @media (min-width: 768px) {
    .post-space {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  .pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 0.5rem;
    margin-top: 2rem;
    padding: 1rem 0;
  }

  .nav-btn, .page-num {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 2.5rem;
    height: 2.5rem;
    padding: 0.5rem;
    border-radius: 0.5rem;
    border: 1px solid #475569;
    color: #94a3b8;
    text-decoration: none;
    transition: all 0.2s ease;
  }

  .nav-btn:hover:not(.disabled), .page-num:hover:not(.active) {
    border-color: #1e40af;
    color: #60a5fa;
  }

  .page-num.active {
    background-color: #1e40af;
    border-color: #1e40af;
    color: white;
  }

  .nav-btn.disabled {
    opacity: 0.3;
    cursor: not-allowed;
    pointer-events: none;
  }

  .tag-section {
    margin-top: 2rem;
    padding: 1.5rem;
    border-radius: 0.75rem;
    border: 1px solid #475569;
  }

  .tag-title {
    font-size: 1.25rem;
    font-weight: 600;
    margin-bottom: 1rem;
    color: #f1f5f9;
  }

  .tag-list {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
  }

  .tag-item {
    display: inline-block;
    padding: 0.375rem 0.75rem;
    border-radius: 9999px;
    background-color: #1e293b;
    color: #94a3b8;
    font-size: 0.875rem;
    text-decoration: none;
    transition: all 0.2s ease;
  }

  .tag-item:hover {
    background-color: #1e40af;
    color: white;
  }

  .tag-count {
    color: #64748b;
    font-size: 0.75rem;
  }

  .tag-item:hover .tag-count {
    color: #93c5fd;
  }
</style>
